---
title: "Dashboard for Pakistan"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: spacelab
    vertical_layout: fill
    #vertical_layout: scroll
    #storyboard: true
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
```
```{r}
library(tidyverse)
library(plotly)
library(cowplot)
library(grid)
library(DT)

# Main Path for getting the data in the form of CSVs
Main <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series"

# We are saving the links to each CSVs in separate objects
confirmed_Path <- file.path(Main,"time_series_19-covid-Confirmed.csv")
Deaths_Path    <- file.path(Main,"time_series_19-covid-Deaths.csv")
Recoverd_Path  <- file.path(Main,"time_series_19-covid-Recovered.csv")

# Now, we are reading the data stored in each link
ConfirmedData <- read.csv(confirmed_Path,stringsAsFactors = FALSE)
DeathData     <- read.csv(Deaths_Path,stringsAsFactors = FALSE)
RecoveredData <- read.csv(Recoverd_Path,stringsAsFactors = FALSE)
# Based on the region, the information will be fetched and prepared
Region <- "Pakistan"

# This function is important for making the data to be used in animations generated by Plotly
accumulate_by <- function(dat, var) {
  var <- lazyeval::f_eval(var, dat) 
  lvls <- plotly:::getLevels(var) 
  dats <- lapply(seq_along(lvls), 
                 function(x) {
                   cbind.data.frame(dat[var %in% lvls[seq(1, x)], ],
                                    frame = lvls[[x]])}) 
  dplyr::bind_rows(dats)}

# This DataClean function is requried to change the wide table into long table and then filtering the data according to region mentioned above
DataClean <- function(data, region, CaseType) {
  CleanedData <- data %>% 
    pivot_longer(cols = starts_with("X"), 
                 names_to = "Date", 
                 names_prefix = "X", 
                 names_ptypes = list(week = integer()), 
                 values_to = CaseType, 
                 values_drop_na = TRUE)   %>% 
    mutate(Province.State = ifelse(Province.State %in% "", Country.Region, Province.State)) %>% 
    mutate(Date = as.Date(Date, "%m.%d.%y")) %>% 
    filter(Province.State == region) %>% 
    arrange(Date) %>% 
    mutate(ID = row_number()) 
  return(CleanedData)
  }

# Now we are cleaning data for each case
ConData <- DataClean(ConfirmedData,Region,"Confirmed") 

RecData <- DataClean(RecoveredData,Region,"Recovered") %>% select(ID,Recovered) 

DeData <-DataClean(DeathData,Region,"Deaths")          %>% select(ID,Deaths)
AllData <- list(ConData, RecData, DeData)              %>% reduce(left_join, by = "ID")


# In this code, we are generating the frames for animations.
frames <- AllData %>% accumulate_by(~ID)
```

 
Geographical Status
=========================================

### Frame 1 {data-commentary-width=400}

```{r}

```

*** 

Some commentary about Frame 1.

### Frame 2

```{r}

```

### Frame 3

```{r}
```

Time Series
=========================================

Row {data-height=650}
-------------------------------------

### Overall situation since the start

```{r}
renderPlotly({fig2 <- plot_ly() %>%  
  
  # We are going to add the information of Confirmed cases by using add_trace()
  add_trace(data=frames, 
            x = ~Date, 
            y = ~Confirmed, 
            name= 'Confirmed', 
            frame = ~frame,  
            type = 'scatter', 
            mode = 'lines+markers', 
            marker = list(size = 10, 
                          color = 'rgba(51, 153, 255, .5)', 
                          line = list(color = 'rgba(0, 38, 77, .8)', width = 2)), 
            line = list(color = 'rgba(0, 38, 77, .8)', 
                        width = 2)) %>% 
  
  # We are going to add the information of Recovered cases by using add_trace()
  add_trace(data=frames, 
            x = ~Date, 
            y = ~Recovered, 
            name='Recovered', 
            frame = ~frame,  
            type = 'scatter', 
            mode = 'lines+markers', 
            marker = list(size = 10, 
                          color = 'rgba(153, 255, 153, .8)', 
                          line = list(color = 'rgba(0, 179, 0, .8)', width = 2)), 
            line = list(color = 'rgba(0, 179, 0, .8)', 
                        width = 2)) %>% 
  
  # We are going to add the information of Deaths by using add_trace()
  add_trace(data=frames, 
            x = ~Date, 
            y = ~Deaths, 
            name='Deaths', 
            frame = ~frame, 
            type = 'scatter', 
            mode = 'lines+markers',
            marker = list(size = 10, 
                          color = 'rgba(255, 102, 102, .5)', 
                          line = list(color = 'rgba(152, 0, 0, .8)', width = 2)), 
            line = list(color = 'rgba(152, 0, 0, 1)', 
                        width = 2)) %>% 
  # Formating the layout of the graph
  layout(legend=list(x = 100, y = 0.5, yanchor="top"), 
         title = list(text=paste("<b> Cases Over the Period of Time in",Region, "Since First Report </b>"), 
                      size = 10), 
         xaxis=list(autoscale=FALSE,
                    range = c(head(frames$Date, n=1),tail(frames$Date, n=1)+2),
                    title = "<b> Days </b>"), 
         yaxis=list(title = "<b> Cases </b>")) %>%
  
  # Animation options
  animation_opts(10, easing = "elastic", redraw = TRUE)

# Plot the fig2
fig2
})
```

Row {data-height=350}
-------------------------------------
   
### Chart 2

```{r}
renderPlotly({subplotly1 <-  plot_ly(AllData, 
                       x = ~Date, 
                       y = ~Confirmed,
                       name='Confirmed', 
                       type = 'scatter', 
                       mode = 'lines+markers',
                       marker = list(size = 10, 
                                     color = 'rgba(51, 153, 255, .5)', 
                                     line = list(color = 'rgba(0, 38, 77, .8)', width = 2)), 
                       line = list(color = 'rgba(0, 38, 77, .8)', 
                                   width = 2))
#plot Subplotly1
subplotly1})
```   
    
### Chart 3

```{r}
renderPlotly({subplotly2 <-  plot_ly(AllData, 
                       x = ~Date, 
                       y = ~Recovered,
                       name='Recovered', 
                       type = 'scatter', 
                       mode = 'lines+markers', 
                       marker = list(size = 10, 
                                     color = 'rgba(153, 255, 153, .8)', 
                                     line = list(color = 'rgba(0, 179, 0, .8)', width = 2)), 
                       line = list(color = 'rgba(0, 179, 0, .8)', 
                                   width = 2))

#plot subplotly2
subplotly2})
```

### Chart 4

```{r}
renderPlotly({subplotly3 <- plot_ly(AllData, 
                      x = ~Date, 
                      y = ~Deaths,
                      name='Deaths',
                      type = 'scatter', 
                      mode = 'lines+markers',
                      marker = list(size = 10, 
                                    color = 'rgba(255, 102, 102, .5)', 
                                    line = list(color = 'rgba(152, 0, 0, .8)', width = 2)), 
                      line = list(color = 'rgba(152, 0, 0, 1)', 
                                  width = 2))

# plot subplotly3
subplotly3})
```



Cleaned Data {data-orientation=rows}
=========================================

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here
```


Row {.tabset .tabset-fade}
-------------------------------------

### Confirmed Cases {data-height=3000}

Celaned

```{r}

DT::renderDataTable({DT::datatable(
  ConData, filter ='top', caption = 'Cleaned Confirmed cases (although authenticated)', options=list(scrollX = TRUE, scrolly = TRUE,pageLength = 10, lengthChange = FALSE)
  )
})
```

### Recovered Cases {data-height=3000}

```{r}
DT::renderDataTable({DT::datatable(
  RecData, filter ='top', caption = 'Cleaned Recovered Data (although authenticated)', options=list(scrollX = TRUE, scrolly = TRUE,pageLength = 10, lengthChange = FALSE)
  )
})
```

### Deaths {data-height=3000}

```{r}
DT::renderDataTable({DT::datatable(
  DeData, filter ='top', caption = 'Cleaned Death Data (although authenticated)', options=list(scrollX = TRUE, scrolly = TRUE,pageLength = 10, lengthChange = FALSE)
  )
})
```

Raw Data {data-orientation=rows}
=========================================

Row {.tabset .tabset-fade}
-------------------------------------

### Confirmed Cases {data-height=3000}

```{r}
DT::renderDataTable({DT::datatable(
  ConfirmedData, filter ='top', caption = 'Raw Confirmed cases (although authenticated)', options=list(scrollX = TRUE, scrolly = TRUE,pageLength = 10, lengthChange = FALSE)
  )
})
```

### Recovered Cases {data-height=3000}

```{r}
DT::renderDataTable({DT::datatable(
  RecoveredData, filter ='top', caption = 'Raw Recovered Data (although authenticated)', options=list(scrollX = TRUE, scrolly = TRUE,pageLength = 10, lengthChange = FALSE)
  )
})
```

### Deaths {data-height=3000}

```{r}
DT::renderDataTable({DT::datatable(
  DeathData, filter ='top', caption = 'Raw Death Data (although authenticated)', options=list(scrollX = TRUE, scrolly = TRUE,pageLength = 10, lengthChange = FALSE)
  )
})
```

